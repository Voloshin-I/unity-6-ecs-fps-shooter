using Unity.Entities;
using Unity.Mathematics;
using Unity.Physics;
using UnityEngine;
using CapsuleCollider = Unity.Physics.CapsuleCollider;

namespace FPSCore
{
    /// <summary>
    /// Player authoring - creates all physics components directly without relying on 
    /// PhysicsShapeAuthoring/PhysicsBodyAuthoring samples.
    /// </summary>
    public class PlayerAuthoring : MonoBehaviour
    {
        [Header("Character")]
        public int health = 100;
        public float moveSpeed = 5f;
        public float lookSpeed = 1f;

        [Header("Physics")]
        public float mass = 1f;
        public float radius = 0.5f;
        public float height = 2f;
    }

    // Alias for backwards compatibility
    [AddComponentMenu("")]
    public class CharacterAuthoring : PlayerAuthoring { }

    public class PlayerBaker : Baker<PlayerAuthoring>
    {
        public override void Bake(PlayerAuthoring authoring)
        {
            var entity = GetEntity(TransformUsageFlags.Dynamic);

            // Create CapsuleCollider - centered like Unity's visual capsule mesh
            float halfHeight = authoring.height / 2f;
            float vertexOffset = halfHeight - authoring.radius;
            
            var capsuleGeometry = new CapsuleGeometry
            {
                Vertex0 = new float3(0, -vertexOffset, 0),
                Vertex1 = new float3(0, vertexOffset, 0),
                Radius = authoring.radius
            };

            var filter = new CollisionFilter
            {
                BelongsTo = ~0u,
                CollidesWith = ~0u,
                GroupIndex = 0
            };

            var collider = CapsuleCollider.Create(capsuleGeometry, filter);
            AddComponent(entity, new PhysicsCollider { Value = collider });

            // Create PhysicsMass - dynamic body with frozen X/Z rotation
            var physicsMass = PhysicsMass.CreateDynamic(collider.Value.MassProperties, authoring.mass);
            physicsMass.InverseInertia = new float3(0f, physicsMass.InverseInertia.y, 0f);
            AddComponent(entity, physicsMass);

            // Add velocity and gravity
            AddComponent(entity, new PhysicsVelocity());
            AddComponent(entity, new PhysicsGravityFactor { Value = 1f });

            // Add damping
            AddComponent(entity, new PhysicsDamping
            {
                Linear = 0.01f,
                Angular = 0.05f
            });

            // Add physics world index
            AddSharedComponent(entity, new PhysicsWorldIndex());

            // Add game components
            AddComponent(entity, new PlayerTag());
            AddComponent(entity, new Movement { MoveSpeed = authoring.moveSpeed, LookSpeed = authoring.lookSpeed });
            AddComponent(entity, new Health { Value = authoring.health });
        }
    }
}
